<!-- vote.html --><!DOCTYPE html><html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Vote on MashStat</title>
  <style>
    body { background-color: #121212; color: white; font-family: Arial, sans-serif; padding: 40px 20px; }
    .logo { display: block; margin: 0 auto 20px; max-width: 200px; }
    h1 { text-align: center; font-size: 2em; }
    .description { text-align: center; max-width: 600px; margin: 0 auto 30px; color: #ccc; }
    form { background-color: #1e1e1e; padding: 25px; border-radius: 10px; max-width: 500px; margin: auto; }
    label { display: block; margin-bottom: 6px; }
    input, select { width: 100%; padding: 10px; margin-bottom: 15px; border: none; border-radius: 5px; background-color: #2a2a2a; color: white; }
    button { background-color: navy; color: white; padding: 12px; border: none; border-radius: 5px; cursor: pointer; font-size: 1em; width: 100%; }
    button:disabled { background-color: #555; }
    #voterInfo { text-align: center; margin-bottom: 20px; color: #aaa; font-size: 0.9em; }
    #message { text-align: center; margin-top: 15px; font-size: 1em; color: lightgreen; }
  </style>  <!-- reCAPTCHA v3 -->  <script src="https://www.google.com/recaptcha/api.js?render=6Lf_jh8rAAAAANoyWe7BwNuD2RvComRRqpTMWJDJ"></script>  <!-- Firebase: auto-config via Hosting init -->  <script src="/__/firebase/9.23.0/firebase-app-compat.js"></script>  <script src="/__/firebase/9.23.0/firebase-auth-compat.js"></script>  <script src="/__/firebase/9.23.0/firebase-functions-compat.js"></script>  <script src="/__/firebase/init.js"></script></head>
<body>
  <img src="mashstat_logo.png" alt="MashStat Logo" class="logo">
  <h1>Vote on MashStat</h1>
  <p class="description">Vote for your favorite song or album. One vote per category per day. Make it count!</p>  <div id="voterInfo">Detecting your voter ID...</div>  <form id="voteForm">
    <label for="city">Your City/Town:</label>
    <input type="text" id="city" name="city" required placeholder="e.g. Norton"><label for="category">Category:</label>
<select id="category" name="category" required>
  <option value="">-- Select --</option>
  <option value="song">Song</option>
  <option value="album">Album</option>
</select>

<label for="title">Title of Song/Album:</label>
<input type="text" id="title" name="title" required placeholder="e.g. Dzoka Kumba">

<label for="artist">Artist Name (Optional):</label>
<input type="text" id="artist" name="artist" placeholder="e.g. Feli Nandi">

<input type="hidden" id="recaptchaToken" name="recaptchaToken">
<button type="submit" id="voteBtn">Submit Vote</button>

  </form>  <div id="message"></div>  <script>
    // Persistent voterId via cookie
    function getCookie(n){return document.cookie.split('; ').find(r=>r.startsWith(n+'='))?.split('=')[1]}
    function setCookie(n,v,a){document.cookie=`${n}=${v};max-age=${a};path=/;Secure;SameSite=Strict`}
    if(!getCookie('voterId')) setCookie('voterId', crypto.randomUUID(), 365*24*60*60);
    const voterId = getCookie('voterId');
    document.getElementById('voterInfo').textContent = `Voter ID: ${voterId}`;

    // Firebase init
    const auth = firebase.auth();
    const voteFan = firebase.functions().httpsCallable('voteFan');

    auth.onAuthStateChanged(user=>{
      if(!user) auth.signInWithPopup(new firebase.auth.GoogleAuthProvider());
    });

    document.getElementById('voteForm').addEventListener('submit', e=>{
      e.preventDefault();
      const city = e.target.city.value.trim();
      const category = e.target.category.value;
      const title = e.target.title.value.trim();
      const artist = e.target.artist.value.trim();
      const voteKey = `voted_${category}_${voterId}`;
      if(getCookie(voteKey)) return alert('You already voted for this category today.');

      grecaptcha.ready(()=> grecaptcha.execute('6Lf_jh8rAAAAANoyWe7BwNuD2RvComRRqpTMWJDJ',{action:'vote'})
        .then(token=>{
          document.getElementById('recaptchaToken').value = token;
          voteFan({ voterId, city, category, title, artist, recaptchaToken: token })
            .then(res=>{
              if(res.data.success){
                setCookie(voteKey,'true',24*60*60);
                document.getElementById('message').textContent='Vote submitted successfully!';
                e.target.reset();
              } else {
                throw new Error(res.data.error||'Vote failed');
              }
            })
            .catch(err=>alert(err.message));
      }));
    });
  </script>  <!-- Cloud Function (functions/index.js) -->  <!--
  const functions = require('firebase-functions');
  const admin = require('firebase-admin');
  const fetch = require('node-fetch');
  admin.initializeApp();

  exports.voteFan = functions.https.onCall(async(data,context)=>{
    const { voterId, city, category, title, artist, recaptchaToken } = data;
    const uid = context.auth?.uid; if(!uid) throw new functions.https.HttpsError('unauthenticated','Sign in required');
    // reCAPTCHA verify
    const resp = await fetch(
      `https://www.google.com/recaptcha/api/siteverify?secret=6Lf_jh8rAAAAAEz4nhHQeFm6R3jQQpHifgujrtfX&response=${recaptchaToken}`,
      { method:'POST' }
    );
    const { success, score } = await resp.json();
    if(!success||score<0.5) throw new functions.https.HttpsError('permission-denied','reCAPTCHA failed');
    // one vote per day
    const voteId = `${category}_${voterId}_${new Date().toISOString().slice(0,10)}`;
    const voteRef = admin.firestore().collection('votes').doc(voteId);
    if((await voteRef.get()).exists) throw new functions.https.HttpsError('already-exists','Already voted today');
    await voteRef.set({ voterId, city, category, title, artist, timestamp: admin.firestore.FieldValue.serverTimestamp() });
    return { success: true };
  });

  // Deploy steps:
  // firebase functions:config:set recaptcha.secret="6Lf_jh8rAAAAAEz4nhHQeFm6R3jQQpHifgujrtfX"
  // firebase deploy --only functions
  --></body>
</html>
