<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>MaRankings – Zimbabwe Music Charts</title>

  <!-- Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-8BMMTDWP3G"></script>
  <script>
    window.dataLayer=window.dataLayer||[];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());
    gtag('config','G-8BMMTDWP3G');
  </script>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <!-- Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600&family=Playfair+Display:wght@700&display=swap" rel="stylesheet">

  <style>
    *{box-sizing:border-box;margin:0;padding:0}
    body{background:#111;color:#eee;font-family:'Montserrat',sans-serif;padding:20px}
    header{text-align:center;margin-bottom:20px;border-bottom:3px solid #ff0055;padding-bottom:10px}
    header .main{font-family:'Playfair Display',serif;font-size:2.5rem;color:#ff0055;text-decoration:none}
    section{margin-top:30px}
    h2, h3{font-family:'Playfair Display',serif;color:#ff0055;margin-bottom:12px}
    h2{font-size:2rem;border-bottom:2px solid #ff0055;padding-bottom:4px}

    .grid2 {display:grid;grid-template-columns:1fr 1fr;gap:16px}
    .city-card, .artist-card {background:#1e1e1e;border-radius:8px;overflow:hidden;position:relative;
      backface-visibility:hidden;transform-style:preserve-3d;transition:transform .6s;cursor:pointer;}
    .city-card.flipped, .artist-card.flipped {transform:rotateY(180deg);}
    .city-front, .artist-front, .artist-back {
      position:absolute;top:0;left:0;width:100%;height:100%;padding:12px;color:#eee;}
    .city-back, .artist-back {transform:rotateY(180deg);backface-visibility:hidden;}

    .city-card img, .artist-card img{width:100%;height:100px;object-fit:cover;border-radius:4px;margin-bottom:8px}
    .rank{font-size:1.2rem;color:#ff0055;font-weight:600;margin-bottom:6px}
    .label{font-size:1rem;font-weight:600;margin-bottom:4px}
    .sub{font-size:0.85rem;color:#ccc}

    .canvas-container{height:80px;margin-top:8px}
    .artist-details{font-size:0.9rem}

    #searchBar{width:100%;padding:12px;margin:16px 0;background:#222;border:none;border-radius:4px;color:#eee}
  </style>
</head>
<body>

  <header>
    <a href="index.html" class="main">MashStat MaRankings</a>
  </header>

  <section>
    <h2>City Popularity Ladder</h2>
    <div id="cityList" class="grid2"></div>
  </section>

  <section>
    <h2>Artist Stats</h2>
    <input id="searchBar" placeholder="Search artist and press Enter…" />
    <div id="artistList" class="grid2"></div>
  </section>

  <footer style="text-align:center;margin-top:40px;font-size:0.8rem;color:#777">
    Data sources: Spotify Web API · Firestore · © 2025 MashStat
  </footer>

<script>
  // FIREBASE INIT
  firebase.initializeApp({
    projectId: "mashstat-vote",
    authDomain: "mashstat-vote.firebaseapp.com",
    apiKey: ""
  });
  const db = firebase.firestore();

  // SPOTIFY CREDENTIALS
  const SPOT_ID     = "9fd373ec645a486d9238ce907ef6662e";
  const SPOT_SECRET = "89e25846b543443ab39fa80504d91fc5";
  let _token, _exp=0;
  async function getToken(){
    if(_token && Date.now()<_exp) return _token;
    const res=await fetch("https://accounts.spotify.com/api/token",{
      method:"POST",
      headers:{
        "Authorization":"Basic "+btoa(SPOT_ID+":"+SPOT_SECRET),
        "Content-Type":"application/x-www-form-urlencoded"
      },
      body:"grant_type=client_credentials"
    });
    const j=await res.json();
    _token=j.access_token;
    _exp=Date.now()+(j.expires_in-60)*1000;
    return _token;
  }

  function normalize(s){return s.trim().toLowerCase().replace(/[^a-z0-9]/g,"");}

  // CACHES
  const artistCache={}, cityCache={};

  // DRAW BAR
  function drawBar(c,labels,data){
    new Chart(c,{type:'bar',data:{labels,datasets:[{data,backgroundColor:'#ff0055',barThickness:8}]},
      options:{indexAxis:'y',plugins:{legend:{display:false}},scales:{x:{beginAtZero:true}}}});
  }

  // LOAD CITY LADDER
  async function loadCityLadder(){
    const ctn=document.getElementById("cityList"); ctn.innerHTML="";
    const snap=await db.collection("votes").get();
    const tots={};
    snap.docs.forEach(d=>{
      const v=d.data(),name=v.song?.artist||v.album?.artist, k=normalize(name);
      tots[k]=tots[k]||{name,count:0,cities:{}};
      tots[k].count++;
      tots[k].cities[v.city]=(tots[k].cities[v.city]||0)+1;
    });
    const arr=Object.values(tots).sort((a,b)=>b.count-a.count).slice(0,50);
    for(let i=0;i<arr.length;i++){
      const e=arr[i];
      if(!artistCache[e.name]){
        const tok=await getToken();
        const r=await fetch(
          `https://api.spotify.com/v1/search?q=${encodeURIComponent(e.name)}&type=artist&limit=1`,
          {headers:{Authorization:"Bearer "+tok}}
        ).then(r=>r.json()).catch(()=>({artists:{items:[]}}));
        artistCache[e.name]=r.artists.items[0]?.images[0]?.url||"news-placeholder.png";
      }
      const img=artistCache[e.name];
      const card=document.createElement("div");card.className="city-card";
      card.innerHTML=`
        <div class="city-front">
          <div class="rank">#${i+1}</div>
          <img src="${img}" alt="${e.name}"/>
          <div class="label">${e.name}</div>
          <div class="sub">${e.count} votes</div>
          <div class="canvas-container"><canvas></canvas></div>
        </div>
        <div class="city-back">
          <div class="rank">#${i+1}</div>
          <div class="label">${e.name}</div>
          <p class="sub">Top 3 Cities</p>
          <div class="canvas-container"><canvas></canvas></div>
        </div>`;
      const data=Object.entries(e.cities).sort((a,b)=>b[1]-a[1]).slice(0,3);
      drawBar(card.querySelectorAll("canvas")[1],data.map(x=>x[0]),data.map(x=>x[1]));
      card.onclick=()=>card.classList.toggle("flipped");
      ctn.appendChild(card);
    }
  }

  // LOAD ARTIST STATS
  const DEFAULT=["Feli Nandi","Nutty O","Holy Ten","Winky D","Gweza","Tamal","Enzo Ishall",
    "Tocky Vibes","Ti Gonzi","Vigro Deep","Selebobo","Lockdown","Soul Jah Love","Killer T","Tamal"];
  async function loadArtistStats(list=DEFAULT){
    const ctn=document.getElementById("artistList"); ctn.innerHTML="";
    for(let name of list){
      if(!artistCache[name]){
        const tok=await getToken();
        const r=await fetch(
          `https://api.spotify.com/v1/search?q=${encodeURIComponent(name)}&type=artist&limit=1`,
          {headers:{Authorization:"Bearer "+tok}}
        ).then(r=>r.json()).catch(()=>({artists:{items:[]}}));
        const a=r.artists.items[0]||{};
        artistCache[name]={
          img:a.images?.[0]?.url||"news-placeholder.png",
          followers:a.followers?.total||0,
          pop:a.popularity||0,
          url:a.external_urls?.spotify||"#"
        };
      }
      const d=artistCache[name],
            card=document.createElement("div");card.className="artist-card";
      card.innerHTML=`
        <div class="artist-front">
          <img src="${d.img}" alt="${name}"/>
          <div class="artist-details">
            <div class="label">${name}</div>
            <div class="sub">Followers: ${d.followers.toLocaleString()}</div>
            <div class="sub">Popularity: ${d.pop}/100</div>
          </div>
        </div>
        <div class="artist-back">
          <img src="${d.img}" alt="${name}"/>
          <div class="artist-details">
            <div class="label">${name}</div>
            <p class="sub">City Votes</p>
            <div class="canvas-container"><canvas></canvas></div>
          </div>
        </div>`;
      card.onclick=async()=>{
        card.classList.toggle("flipped");
        if(!cityCache[name]){
          const snap=await db.collection("votes").where("song.artist","==",name).get().catch(()=>({docs:[]})),
                cnts={};
          snap.docs.forEach(d=>{const c=d.data().city; cnts[c]=(cnts[c]||0)+1;});
          cityCache[name]=Object.entries(cnts).sort((a,b)=>b[1]-a[1]).slice(0,3);
        }
        const data=cityCache[name],
              cvs=card.querySelectorAll("canvas")[1];
        drawBar(cvs,data.map(x=>x[0]),data.map(x=>x[1]));
      };
      ctn.appendChild(card);
    }
  }

  document.getElementById("searchBar").addEventListener("keydown",e=>{
    if(e.key==="Enter"&&e.target.value.trim()){
      loadArtistStats([e.target.value.trim()]);
      e.target.value="";
    }
  });

  window.addEventListener("load",()=>{
    loadCityLadder();
    loadArtistStats();
  });
</script>
</body>
</html>
