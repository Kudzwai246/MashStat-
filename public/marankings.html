<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>MashStat – MaRankings</title>

  <!-- Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-8BMMTDWP3G"></script>
  <script>
    window.dataLayer=window.dataLayer||[];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());
    gtag('config','G-8BMMTDWP3G');
  </script>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <!-- Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600&family=Playfair+Display:wght@700&display=swap" rel="stylesheet">

  <style>
    * { box-sizing:border-box; margin:0; padding:0 }
    body { background:#111; color:#eee; font-family:'Montserrat',sans-serif; padding:20px }
    header { text-align:center; margin-bottom:20px }
    header .main { font-family:'Playfair Display',serif; font-size:2.5rem; color:#ff0055; text-decoration:none }
    input#searchBar { width:100%; padding:12px; margin:15px 0; background:#222; border:none; border-radius:4px; color:#eee }

    section + section { margin-top:40px }
    h2.section-title { font-family:'Playfair Display',serif; color:#ff0055; font-size:1.8rem; margin-bottom:12px; border-bottom:2px solid #ff0055; display:inline-block; padding-bottom:4px }

    .loading { text-align:center; color:#888; margin:20px 0 }

    .grid-2 { display:grid; grid-template-columns:repeat(auto-fit,minmax(140px,1fr)); gap:16px }
    .city-card, .artist-card { background:#1e1e1e; border-radius:8px; overflow:hidden; position:relative; cursor:pointer; transition:transform .2s }
    .city-card:hover, .artist-card:hover { transform:scale(1.02) }

    .city-card img, .artist-card img { width:100%; height:100px; object-fit:cover; background:#333 }
    .city-card .info, .artist-card .info { padding:12px }
    .city-card .rank { font-size:1.2rem; color:#ff0055; font-weight:600; margin-bottom:4px }
    .city-card .label { color:#fff; font-size:1rem; margin-bottom:6px }
    .city-card canvas { width:100%!important; height:80px!important; }

    .artist-card .front, .artist-card .back { backface-visibility:hidden; transition:transform .5s; position:relative; }
    .artist-card .back { position:absolute; top:0; left:0; width:100%; height:100%; transform:rotateY(180deg); }
    .artist-card.flipped .front { transform:rotateY(180deg); }
    .artist-card.flipped .back  { transform:rotateY(0deg); }
    .artist-card .front img, .artist-card .back img { height:120px; }

    .artist-card .info { padding:10px; color:#ccc }
    .artist-card h3 { color:#ff0055; font-size:1rem; margin-bottom:6px }
    .artist-card .meta { font-size:0.85rem; margin-bottom:6px }
    .artist-card .meta strong { color:#fff }
    .artist-card .links a { display:inline-block; padding:4px 6px; font-size:0.75rem; border-radius:4px; color:#fff; text-decoration:none; margin-right:4px }
    .spotify { background:#1DB954 } .youtube { background:#FF0000 } .apple { background:#000 }

  </style>
</head>
<body>

  <header><a href="index.html" class="main">MashStat MaRankings</a></header>
  <input id="searchBar" placeholder="Search artist and press Enter…" />

  <section id="citySection">
    <h2 class="section-title">City Popularity Ladder</h2>
    <div id="cityLoading" class="loading">Loading top artists…</div>
    <div id="cityList" class="grid-2"></div>
  </section>

  <section id="artistSection">
    <h2 class="section-title">Artist Stats</h2>
    <div id="artistLoading" class="loading">Loading artist stats…</div>
    <div id="artistContainer" class="grid-2"></div>
  </section>

<script>
  // — Firebase init
  firebase.initializeApp({
    apiKey:    "AIzaSyDyJg5BfmGhoi5ESsfhF6ZRFDG0Xfdoy10",
    authDomain:"mashstat-vote.firebaseapp.com",
    projectId: "mashstat-vote"
  });
  const db = firebase.firestore();

  // — Token proxy
  async function getToken(){
    const r = await fetch('http://localhost:3001/token');
    return (await r.json()).token;
  }

  // — normalize
  function normalize(s){ return s.trim().toLowerCase().replace(/[^a-z0-9]/g,''); }

  // — City Popularity
  const cityLoading = document.getElementById('cityLoading'),
        cityList    = document.getElementById('cityList');

  db.collection('votes').onSnapshot(async snap => {
    cityLoading.style.display='block';
    cityList.innerHTML='';

    // tally per artist
    const m = {};
    snap.docs.forEach(d=>{
      const v = d.data();
      const key = normalize(v.album.artist||v.song.artist);
      if(!m[key]) m[key]= { name:v.album.artist||v.song.artist, cityCounts:{}, total:0 };
      m[key].total++;
      m[key].cityCounts[v.city] = (m[key].cityCounts[v.city]||0)+1;
    });

    // sort & rank
    const arr = Object.values(m).sort((a,b)=>b.total-a.total);
    for(let i=0;i<arr.length;i++){
      const e = arr[i];
      // build card
      const card = document.createElement('div'); card.className='city-card';
      // thumbnail fallback
      const img = document.createElement('img');
      img.src = 'https://via.placeholder.com/300?text='+encodeURIComponent(e.name);
      card.appendChild(img);
      const info = document.createElement('div'); info.className='info';
      info.innerHTML = '<div class="rank">#'+(i+1)+'</div>'
                     +'<div class="label">'+e.name+'</div>'
                     +'<canvas></canvas>';
      card.appendChild(info);
      cityList.appendChild(card);

      // draw chart
      const ctx = card.querySelector('canvas');
      new Chart(ctx, {
        type:'bar',
        data:{ labels:Object.keys(e.cityCounts), datasets:[{ data:Object.values(e.cityCounts), backgroundColor:'#ff0055', barThickness:8 }] },
        options:{ indexAxis:'y', scales:{ x:{ beginAtZero:true }}, plugins:{ legend:{ display:false }}, maintainAspectRatio:false }
      });
    }

    cityLoading.style.display='none';
  });

  // — Artist Stats
  const artistLoading   = document.getElementById('artistLoading'),
        artistContainer = document.getElementById('artistContainer'),
        searchBar       = document.getElementById('searchBar');

  let statsList = [], shown=0, token='';

  // fetch details + cache
  const cache = {};
  async function fetchArtist(name){
    const key = normalize(name);
    if(cache[key]) return cache[key];
    if(!token) token = await getToken();
    const res = await fetch(
      'https://api.spotify.com/v1/search?type=artist&limit=1&q='+encodeURIComponent(name),
      { headers:{ 'Authorization':'Bearer '+token } }
    );
    const js = await res.json(), a = js.artists.items[0]||{};
    const det = {
      name:      a.name||name,
      image:     a.images?.[0]?.url||'https://via.placeholder.com/300?text='+encodeURIComponent(name),
      followers: a.followers?.total||0,
      popularity:a.popularity||0,
      urls:      { spotify:a.external_urls?.spotify||'#' }
    };
    return cache[key]=det;
  }

  async function renderArtists(names){
    artistLoading.style.display='block';
    artistContainer.innerHTML='';
    // fetch in parallel
    const details = await Promise.all(names.map(fetchArtist));
    details.forEach((d,i)=>{
      const card = document.createElement('div'); card.className='artist-card';
      card.innerHTML = \`
        <div class="front">
          <img src="\${d.image}" alt="\${d.name}"/>
          <div class="info">
            <h3>\${d.name}</h3>
            <div class="meta"><strong>Followers:</strong> \${d.followers.toLocaleString()}</div>
            <div class="links"><a class="spotify" href="\${d.urls.spotify}" target="_blank">Spotify</a></div>
          </div>
        </div>
        <div class="back">
          <img src="\${d.image}" alt="\${d.name}"/>
          <div class="info">
            <h3>Popularity</h3>
            <div class="meta"><strong>Score:</strong> \${d.popularity}/100</div>
          </div>
        </div>\`;
      // flip on click
      card.onclick = ()=> card.classList.toggle('flipped');
      artistContainer.appendChild(card);
    });
    artistLoading.style.display='none';
  }

  // initial defaults + search
  const defaults = ['Feli Nandi','Nutty O','Holy Ten','Winky D'];
  renderArtists(defaults);

  searchBar.addEventListener('keydown', async e=>{
    if(e.key==='Enter'){
      const v = searchBar.value.trim();
      if(!v) return;
      searchBar.disabled=true;
      searchBar.placeholder='Searching…';
      await renderArtists([v, ...defaults]);
      searchBar.value='';
      searchBar.placeholder='Search artist and press Enter…';
      searchBar.disabled=false;
    }
  });
</script>
</body>
</html>
