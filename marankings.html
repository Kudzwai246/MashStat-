<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" /><meta name="viewport" content="width=device-width,initial-scale=1.0"/>
  <title>MaRankings – Zimbabwe Music Charts</title>
  <!-- Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-8BMMTDWP3G"></script>
  <script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments);}gtag('js',new Date());gtag('config','G-8BMMTDWP3G');</script>
  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600&family=Playfair+Display:wght@700&display=swap" rel="stylesheet">
  <style>
    /* … (same CSS as before) … */
    #artistContainer{display:grid;grid-template-columns:1fr 1fr;gap:16px;margin-top:15px}
  </style>
</head>
<body>
  <header><a href="index.html" class="main">MashStat</a></header>
  <input id="searchBar" placeholder="Search artist and press Enter…" />

  <section>
    <h3>City Popularity</h3>
    <div id="cityLoading">Loading city popularity…</div>
    <div id="cityList"></div>
  </section>

  <section>
    <h3>Artist Stats</h3>
    <div id="artistLoading">Loading artist stats…</div>
    <div id="artistContainer"></div>
    <button id="loadMore" style="display:none;">Load more artists</button>
    <p id="searchPrompt" style="display:none;">Search artist to see stats</p>
  </section>

  <footer>Data sources: Spotify Web API · Firestore © 2025 MashStat / MaRankings</footer>

<script>
  // Firebase init
  firebase.initializeApp({
    apiKey:"AIzaSyDyJg5BfmGhoi5ESsfhF6ZRFDG0Xfdoy10",
    authDomain:"mashstat-vote.firebaseapp.com",
    projectId:"mashstat-vote"
  });
  const db=firebase.firestore();

  // Spotify creds & caching
  const SPOT_ID="9fd373ec645a486d9238ce907ef6662e",
        SPOT_SECRET="89e25846b543443ab39fa80504d91fc5";
  let spotifyToken;
  const cache={};

  async function getToken(){
    if(spotifyToken) return spotifyToken;
    let r=await fetch("https://accounts.spotify.com/api/token",{method:"POST",
      headers:{"Authorization":"Basic "+btoa(SPOT_ID+":"+SPOT_SECRET),
               "Content-Type":"application/x-www-form-urlencoded"},
      body:"grant_type=client_credentials"});
    spotifyToken=(await r.json()).access_token; return spotifyToken;
  }
  function norm(n){return n.trim().toLowerCase().replace(/[^a-z0-9]/g,"");}

  async function getArtist(name){
    let k=norm(name);
    if(cache[k]?.detail) return cache[k].detail;
    let token=await getToken();
    let r=await fetch(`https://api.spotify.com/v1/search?q=${encodeURIComponent(name)}&type=artist&limit=1`,
                      {headers:{"Authorization":"Bearer "+token}});
    let j=await r.json(),a=j.artists.items[0];
    let det={ name:a.name,
              image:a.images[0]?.url||"",
              followers:a.followers.total,
              popularity:a.popularity,
              urls:{spotify:a.external_urls.spotify}
            };
    cache[k]={detail:det,thumb:det.image};
    return det;
  }

  function drawBar(c,labels,data){
    new Chart(c,{type:'bar',data:{labels,datasets:[{data,backgroundColor:'#ff0055',barThickness:6}]},
      options:{indexAxis:'y',scales:{x:{beginAtZero:true}},plugins:{legend:{display:false}}}});
  }

  function merge(v){
    let m={};
    v.forEach(x=>{
      let k=norm(x.song.artist);
      if(!m[k]) m[k]={song:x.song,city:{},count:0};
      m[k].count++; m[k].city[x.city]=(m[k].city[x.city]||0)+1;
    });
    return Object.values(m).sort((a,b)=>b.count-a.count);
  }

  // CITY CARDS
  const cityL=document.getElementById("cityList"), cityLoad=document.getElementById("cityLoading");
  db.collection('votes').onSnapshot(async s=>{
    cityLoad.style.display='block'; cityL.innerHTML='';
    let data=merge(s.docs.map(d=>d.data()));
    for(let i=0;i<data.length;i++){
      let v=data[i], det=await getArtist(v.song.artist);
      let card=document.createElement("div"); card.className="city-card";
      card.innerHTML=`
        <div class="rank">#${i+1}</div>
        <img src="${det.image}" alt="${det.name}"/>
        <div class="meta-block"><h4>Followers</h4><p>${det.followers.toLocaleString()}</p></div>
        <canvas></canvas>
        <button class="toggle-stats">Stats</button>`;
      drawBar(card.querySelector("canvas"),Object.keys(v.city),Object.values(v.city));
      cityL.appendChild(card);
      card.querySelector(".toggle-stats").onclick=()=>{/* toggle as before */};
    }
    cityLoad.style.display='none';
  });

  // ARTIST STATS
  const artL=document.getElementById("artistLoading"),
        artC=document.getElementById("artistContainer"),
        loadMore=document.getElementById("loadMore"),
        searchPrompt=document.getElementById("searchPrompt"),
        sb=document.getElementById("searchBar");
  let stats=[],shown=0;

  async function loadDefaults(){
    artL.style.display='block';
    let defaults=["Feli Nandi","Nutty O","Holy Ten","Winky D"];
    stats=await Promise.all(defaults.map(getArtist));
    shown=stats.length; render();
    artL.style.display='none';
  }
  loadDefaults();

  function render(){
    artC.innerHTML='';
    for(let i=0;i<shown && i<stats.length;i++){
      let d=stats[i],c=document.createElement("div");c.className="artist-card";
      c.innerHTML=`<img src="${d.image}" alt="${d.name}"/><div class="artist-details">
        <div class="artist-name">${d.name}</div>
        <div class="meta-block"><h4>Followers</h4><p>${d.followers.toLocaleString()}</p></div>
        <div class="meta-block"><h4>Popularity</h4><p>${d.popularity}/100</p></div>
        <div class="links">
          <a class="spotify" href="${d.urls.spotify}" target="_blank">Spotify</a>
        </div>
      </div>`;
      artC.appendChild(c);
    }
    loadMore.style.display=shown<stats.length?'block':'none';
    searchPrompt.style.display=shown>=stats.length?'block':'none';
  }
  loadMore.onclick=()=>{shown+=4;render();};

  sb.addEventListener("keydown",async e=>{
    if(e.key==='Enter'){
      e.preventDefault();
      let name=sb.value.trim(); if(!name)return;
      artL.style.display='block';
      let d=await getArtist(name);
      stats.unshift(d); shown++; render();
      artL.style.display='none'; sb.value='';
    }
  });
</script>
</body>
</html>
