<!DOCTYPE html><html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1.0"/>
  <title>MaRankings ‚Äì Zimbabwe Music Charts</title>
  <!-- Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-8BMMTDWP3G"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}  gtag('js', new Date());  gtag('config', 'G-8BMMTDWP3G');
  </script>
  <style>
    * { box-sizing: border-box; margin:0; padding:0; }
    body { background: #0d0d0d; color: #e0e0e0; font-family: 'Segoe UI', sans-serif; padding: 20px; }
    header { text-align: center; margin-bottom: 20px; }
    header a.main { color: #ff3c78; font-size: 2.5rem; font-weight: bold; text-decoration: none; }
    header h2.sub { color: #bbbbbb; margin-top: 8px; font-size: 1.5rem; }
    #searchBar { width:100%; padding:12px; margin:20px 0; font-size:1rem; border:none; border-radius:8px; background:#1a1a1a; color:#e0e0e0; }
    .section { margin-top:30px; }
    .section h3 { color:#ff3c78; font-size:1.5rem; font-weight:700; margin-bottom:15px; }
    #cityList { display:flex; flex-wrap:wrap; gap:16px; }
    .city-card { background:#181818; padding:12px; border-radius:8px; width:200px; cursor:pointer; }
    .city-card:hover { background:#202020; }
    .artist-card { background:#181818; border-radius:12px; overflow:hidden; box-shadow:0 6px 20px rgba(0,0,0,0.4); transition:transform 0.2s; padding-bottom:10px; margin-top:30px; }
    .artist-card:hover { transform:scale(1.02); }
    .artist-img { display:block; width:100%; height:180px; object-fit:cover; background:#333; }
    .artist-details { padding:1rem; }
    .artist-name { font-size:1.3rem; margin-bottom:0.5rem; color:#fff; font-weight:600; }
    .meta-block { margin-bottom:12px; }
    .meta-block h4 { margin-bottom:6px; font-size:1rem; color:#ff3c78; font-weight:600; }
    .meta-block p { font-size:0.9rem; color:#ccc; margin:2px 0; }
    .artist-links a { display:inline-block; margin:4px 6px 0 0; font-size:0.8rem; text-decoration:none; padding:6px 10px; border-radius:5px; transition:background-color 0.3s; color:#fff; }
    .artist-links a.spotify { background:#4da6ff; }
    .artist-links a.youtube { background:#ff0000; }
    .artist-links a.itunes  { background:#fa2a55; }
    #loading { text-align:center; color:#888; font-size:1rem; margin:20px 0; }
    footer { text-align:center; margin-top:40px; font-size:0.8rem; color:#777; }
  </style>
</head>
<body>
  <header>
    <a href="index.html" class="main">MashStat</a>
    <h2 class="sub">MaRankings</h2>
  </header>  <input id="searchBar" placeholder="Search for any artist (Zimbabwean or international) and hit Enter‚Ä¶" />  <!-- City Popularity Section -->  <div class="section">
    <h3>üìç City Popularity</h3>
    <div id="cityList"></div>
  </div>  <!-- Artist Stats Section -->  <div class="section">
    <h3>üéµ Artist Stats</h3>
    <div id="loading">Loading artist stats‚Ä¶</div>
    <div id="artistContainer"></div>
  </div>  <footer>
    Data sources: Spotify Web API ¬∑ YouTube Data API ¬∑ iTunes Search API<br>
    ¬© 2025 MashStat / MaRankings
  </footer>  <script>
    // Firestore init (compat)
    firebase.initializeApp({
      apiKey: "AIzaSyDyJg5BfmGhoi5ESsfhF6ZRFDG0Xfdoy10",
      authDomain: "mashstat-vote.firebaseapp.com",
      projectId: "mashstat-vote"
    });
    const db = firebase.firestore();

    // Fetch all votes and aggregate
    async function fetchVotes() {
      const snap = await db.collection('votes').get();
      return snap.docs.map(d=>d.data());
    }
    function aggregate(votes) {
      const total={}, cityMap={};
      votes.forEach(v=>{
        const a=v.song.artist;
        total[a]=(total[a]||0)+1;
        cityMap[a]=cityMap[a]||{};
        cityMap[a][v.city]=(cityMap[a][v.city]||0)+1;
      });
      return {total, cityMap};
    }

    // Render City Popularity
    async function showCity() {
      const votes=await fetchVotes();
      const {total, cityMap}=aggregate(votes);
      const sorted=Object.entries(total).sort((a,b)=>b[1]-a[1]);
      const list=document.getElementById('cityList');
      sorted.forEach(([artist,count],i)=>{
        const card=document.createElement('div'); card.className='city-card';
        card.innerHTML=`<div style="font-size:1.1em;color:#ff3c78;font-weight:600;">#${i+1} ${artist}</div>
                          <div style="font-size:0.9em;margin-bottom:8px;">Votes: ${count}</div>
                          <div id="bars-${i}"></div>`;
        list.appendChild(card);
        // top 3 cities bars
        const cities=Object.entries(cityMap[artist]).sort((a,b)=>b[1]-a[1]).slice(0,3);
        const max=cities[0]?[cities[0][1]]: [1];
        cities.forEach(([city,c])=>{
          const wrap=document.createElement('div'); wrap.style.display='flex'; wrap.style.alignItems='center'; wrap.style.marginBottom='4px';
          const lbl=document.createElement('div'); lbl.textContent=city; lbl.style.width='60px'; lbl.style.fontSize='0.8em';
          const bar=document.createElement('div'); bar.style.height='8px'; bar.style.width=`${(c/max)*100}%`; bar.style.background='#4da6ff'; bar.style.marginLeft='6px';
          wrap.appendChild(lbl); wrap.appendChild(bar);
          card.querySelector(`#bars-${i}`).appendChild(wrap);
        });
        card.addEventListener('click',()=>loadArtistStats(artist));
      });
    }

    // Load stats for clicked artist
    async function loadArtistStats(name) {
      document.getElementById('artistContainer').innerHTML='';
      document.getElementById('loading').style.display='block';
      const tokenResp=await fetch("https://accounts.spotify.com/api/token",{
        method:'POST', headers:{'Authorization':'Basic '+btoa('9fd373ec645a486d9238ce907ef6662e'+':'+
        '89e25846b543443ab39fa80504d91fc5'), 'Content-Type':'application/x-www-form-urlencoded'},
        body:'grant_type=client_credentials'
      });
      const token=(await tokenResp.json()).access_token;
      const d=await fetchArtist(name, token, true);
      document.getElementById('loading').style.display='none';
      document.getElementById('artistContainer').appendChild(buildCard(d));
    }

    // Search handler
    document.getElementById('searchBar').addEventListener('keydown',e=>{
      if(e.key==='Enter'){ e.preventDefault(); loadArtistStats(e.target.value.trim()); }
    });

    // Utility: fetchArtist & buildCard (reuse code)
    const SPOT_ID='9fd373ec645a486d9238ce907ef6662e', SPOT_SECRET='89e25846b543443ab39fa80504d91fc5';
    async function fetchArtist(name, token, force=false){
      let data={name,image:'',followers:null,popularity:null,spotifyUrl:null,youtubeSubs:null,youtubeUrl:null,iTunesUrl:null};
      try{const r=await fetch(`https://api.spotify.com/v1/search?q=${encodeURIComponent(name)}&type=artist&limit=1`,{headers:{'Authorization':'Bearer '+token}}),j=await r.json(),a=j.artists.items[0]; if(a)Object.assign(data,{name:a.name,image:a.images[0]?.url||'',followers:a.followers.total,popularity:a.popularity,spotifyUrl:a.external_urls.spotify});}catch{}
      return data;
    }
    function buildCard(d){const div=document.createElement('div');div.className='artist-card';div.innerHTML=`<img class="artist-img" src="${d.image||'https://via.placeholder.com/300x150?text='+encodeURIComponent(d.name)}" alt="${d.name}"><div class="artist-details"><h3 class="artist-name">${d.name}</h3><div class="meta-block"><h4>Spotify</h4>${d.followers!==null?`<p>Followers: ${d.followers.toLocaleString()}</p>`:''}</div><div class="artist-links">${d.spotifyUrl?`<a class="spotify" href="${d.spotifyUrl}" target="_blank">Spotify</a>`:''}</div></div>`;return div;}

    // init
    showCity();
  </script></body>
</html>
